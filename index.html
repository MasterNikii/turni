<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nikita Pro</title>
    <script src="turni.js"></script>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f8fafc; 
            --red: #ff4d4d; --green: #22c55e; --orange: #f59e0b; --gray: #94a3b8; 
            --border: #334155;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .wrapper { width: 100%; max-width: 480px; margin: 0 auto; }
        
        #countdown-lavoro { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05));
            border-left: 5px solid var(--accent); color: var(--accent);
            padding: 18px; border-radius: 10px; font-weight: 900; text-align: center;
            font-size: 1.3em; margin-bottom: 25px; display: none;
        }

        .card { background: var(--card); border-radius: 14px; margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .card-header { padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #1e293b; }
        .card-header b { font-size: 1.1em; text-transform: uppercase; }
        .tag-serv { background: var(--accent); color: white; padding: 6px 14px; border-radius: 8px; font-weight: 900; font-size: 1.2em; }
        
        .card-body { display: none; background: #111827; padding-top: 20px; padding-bottom: 30px; }
        .card.open .card-body { display: block; }
        
        .park-badge { padding: 15px; text-align: center; font-weight: 900; margin: 0 15px 20px 15px; border-radius: 10px; text-transform: uppercase; font-size: 0.9em; border: 2px solid transparent; }
        .park-peretola { background: rgba(59, 130, 246, 0.15); color: var(--accent); border-color: var(--accent); }
        .park-careggi { background: rgba(245, 158, 11, 0.15); color: var(--orange); border-color: var(--orange); }

        .viaggio-row { display: flex; padding: 20px 15px; border-bottom: 1px solid var(--border); align-items: center; }
        .ora-box { min-width: 85px; color: var(--red); font-weight: 900; text-align: center; font-size: 1.3em; border-right: 2px solid var(--border); padding-right: 15px; margin-right: 15px; line-height: 1.1; }
        .ora-box span { font-size: 0.6em; color: var(--gray); display: block; text-transform: uppercase; margin: 3px 0; }
        
        .tm-badge { display: inline-block; background: var(--accent); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 900; font-size: 1em; margin-bottom: 8px; box-shadow: 0 3px 0px #1d4ed8; }
        .nodi { font-weight: 800; font-size: 1.2em; color: #ffffff; line-height: 1.3; }
        
        .pausa-label { margin: 25px 15px 10px 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); color: var(--green); border-radius: 8px; font-weight: 900; text-align: center; border: 1px solid var(--green); }

        .trasp-box { margin: 40px 15px 15px 15px; padding: 20px; background: #1e293b; border-radius: 12px; border-left: 6px solid var(--gray); }
        .durata-highlight { color: #fff; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 6px; font-weight: 900; margin-top: 10px; display: inline-block; }

        .btn-main { background: var(--accent); color: white; border: none; padding: 22px; border-radius: 15px; font-weight: 900; font-size: 1.3em; cursor: pointer; width: 100%; margin-bottom: 15px; }
        .btn-passati { background: #334155; font-size: 1.1em; padding: 15px; }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="unlock-screen" style="text-align:center; padding-top:80px;">
        <h1 style="color:var(--accent); font-size: 2.8em; margin-bottom: 5px;">NIKITA PRO</h1>
        <p style="color: var(--gray); margin-bottom: 50px;">Gestione Turni</p>
        <button class="btn-main" onclick="avvia('attuali')">üìÇ ACCEDI AI TURNI</button>
        <button class="btn-main btn-passati" onclick="avvia('passati')">üìú TURNI PASSATI</button>
    </div>
    
    <div id="app-view" style="display:none;">
        <div id="countdown-lavoro"></div>
        <div id="lista-turni"></div>
        <button onclick="location.reload()" style="width:100%; margin-top:30px; background:transparent; border:1px solid var(--gray); color:var(--gray); padding:12px; border-radius:10px; font-weight:bold;">‚¨ÖÔ∏è HOME</button>
    </div>
</div>

<script>
    function isPassato(turno) {
    try {
        const parti = turno.data_estesa.split(" "); // "LUN", "16"
        if (parti.length < 2) return false;

        const gTurno = parseInt(parti[1]);
        const oggi = new Date();
        const gOggi = oggi.getDate();
        const mOggi = oggi.getMonth();
        const aOggi = oggi.getFullYear();

        // 1. Se il numero del giorno √® pi√π piccolo di oggi (es. turno 16, oggi 17)
        // (Gestiamo anche il caso fine mese: se oggi √® 1 e il turno √® 30/31)
        let giornoPassato = false;
        if (gTurno < gOggi) giornoPassato = true;
        if (gOggi === 1 && gTurno > 25) giornoPassato = false; // Turno del mese scorso

        if (giornoPassato) {
            if (!turno.viaggi || turno.viaggi.length === 0) return true;

            // Controlliamo se √® un turno che finisce all'alba di oggi
            const ultimaFine = turno.viaggi[turno.viaggi.length - 1].fine.replace(':', '.');
            const oreFine = parseInt(ultimaFine.split(".")[0]);

            if (oreFine >= 0 && oreFine <= 5) {
                // Finisce oggi mattina
                const [h, m] = ultimaFine.split(".").map(Number);
                const fineEffettiva = new Date(aOggi, mOggi, gOggi, h, m);
                const scadenza = new Date(fineEffettiva.getTime() + 30 * 60000);
                return oggi > scadenza;
            }
            return true;
        }

        // 2. Se √® il giorno stesso (oggi)
        if (gTurno === gOggi) {
            if (!turno.viaggi || turno.viaggi.length === 0) return false;

            const ultimaFine = turno.viaggi[turno.viaggi.length - 1].fine.replace(':', '.');
            const [h, m] = ultimaFine.split(".").map(Number);
            
            // Se l'ora di fine √® tra le 00 e le 05, tecnicamente finisce DOMANI 
            if (h >= 0 && h <= 5) return false; 

            const fineEffettiva = new Date(aOggi, mOggi, gOggi, h, m);
            const scadenza = new Date(fineEffettiva.getTime() + 30 * 60000);
            return oggi > scadenza;
        }

        return false; // Futuro
    } catch (e) {
        console.error("Errore:", e);
        return false;
    }
}

    function calcolaDiff(inz, fine) {
        try {
            if (!inz || !fine) return 0;
            let t1 = new Date(`2000-01-01T${inz.replace('.', ':')}:00`);
            let t2 = new Date(`2000-01-01T${fine.replace('.', ':')}:00`);
            let d = (t2 - t1) / 60000;
            return d < 0 ? d + 1440 : d;
        } catch (e) { return 0; }
    }

    function formatta(m) {
        let ore = Math.floor(m / 60); let min = m % 60;
        return ore > 0 ? `${ore}h ${min < 10 ? '0' + min : min}m` : `${min} min`;
    }

    function avvia(tipo) {
        if (localStorage.getItem("nikita_auth") !== "y") {
            let p = prompt("PIN:");
            if (p === "1234") { localStorage.setItem("nikita_auth", "y"); } else { return; }
        }
        document.getElementById('unlock-screen').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        render(tipo);
        if (tipo === 'attuali') startShiftCountdown();
    }

    function render(tipo) {
        const container = document.getElementById('lista-turni');
        container.innerHTML = "";
        
        // Verifichiamo che i dati esistano
        if (typeof datiTurni === 'undefined' || !datiTurni) {
            container.innerHTML = "<p style='text-align:center; color:var(--gray); padding:50px;'>Errore: Dati non caricati (file turni.js mancante?).</p>";
            return;
        }

        const filtrati = datiTurni.filter(t => {
            const passato = isPassato(t);
            return tipo === 'passati' ? passato : !passato;
        });

        if (filtrati.length === 0) {
            container.innerHTML = `<p style='text-align:center; color:var(--gray); padding:50px;'>Nessun turno ${tipo === 'passati' ? 'passato' : 'in programma'}.</p>`;
            return;
        }

        filtrati.forEach((t, i) => {
            const card = document.createElement('div');
            card.className = "card" + (i === 0 ? " open" : "");
            let badgeP = t.parcheggio ? `<div class="park-badge park-${t.parcheggio.toLowerCase()}">üÖøÔ∏è AUTO A ${t.parcheggio.toUpperCase()}</div>` : "";
            card.innerHTML = `
                <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
                    <b>${t.data_estesa}</b>
                    <span class="tag-serv">${t.servizio}</span>
                </div>
                <div class="card-body">
                    ${badgeP}
                    ${disegnaViaggi(t.viaggi)}
                </div>`;
            container.appendChild(card);
        });
    }

    function disegnaViaggi(viaggi) {
        if (!viaggi || viaggi.length === 0) return "<p style='text-align:center; color:var(--gray); padding:20px;'>RIPOSO / FERIE</p>";
        let h = "";
        viaggi.forEach((v, i) => {
            let dur = calcolaDiff(v.inizio, v.fine);
            if (!v.tm) {
                h += `<div class="trasp-box"><b>${v.inizio} ‚ûú ${v.fine}</b><br><small style="color:var(--gray)">RAGGIUNGIMENTO</small><br>${v.da} ‚ûú ${v.a}<br><span class="durata-highlight">‚è±Ô∏è ${formatta(dur)}</span></div>`;
            } else {
                h += `<div class="viaggio-row"><div class="ora-box">${v.inizio}<span>AL</span>${v.fine}</div><div><div class="tm-badge">TM ${v.tm}</div><div class="nodi">${v.da}<br>‚ûú ${v.a}</div></div></div>`;
                if (v.pausa) h += `<div class="pausa-label">‚òï PAUSA: ${v.pausa}</div>`;
            }
            if (i < viaggi.length - 1 && !v.pausa) {
                let s = calcolaDiff(v.fine, viaggi[i + 1].inizio);
                if (s > 0) h += `<div class="trasp-box" style="margin: 40px 15px; border-left-style: dashed; background:rgba(255,255,255,0.03)"><small>SPOSTAMENTO TECNICO</small><br><span class="durata-highlight">${formatta(s)}</span></div>`;
            }
        });
        return h;
    }

    function startShiftCountdown() {
        const display = document.getElementById('countdown-lavoro');
        const update = () => {
            const oggi = (datiTurni || []).find(t => !isPassato(t) && t.viaggi && t.viaggi.length > 0);
            if (!oggi) { display.style.display = 'none'; return; }
            let oraAttuale = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }).replace(':', '.');
            let diff = calcolaDiff(oraAttuale, oggi.viaggi[0].inizio);
            if (diff > 0 && diff < 720) {
                display.style.display = 'block';
                display.innerText = `‚è≥ INIZIA TRA: ${formatta(Math.floor(diff))}`;
            } else { display.style.display = 'none'; }
        };
        update(); setInterval(update, 60000);
    }
</script>
</body>
</html>