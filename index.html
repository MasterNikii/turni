<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Area Turni Nikita</title>
    <script src="turni.js"></script>
    <style>
        :root { --bg: #0b1120; --card: #1e293b; --accent: #3b82f6; --text: #f1f5f9; --timer: #fbbf24; --red: #f87171; --green: #22c55e; --gray: #64748b; --purple: #a855f7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .wrapper { width: 100%; max-width: 500px; }
        #unlock-screen { text-align: center; margin-top: 80px; }
        .btn-entra { background: var(--accent); color: white; border: none; padding: 20px 45px; border-radius: 15px; font-size: 1.4em; font-weight: bold; cursor: pointer; }
        .update-info { font-size: 0.75em; color: var(--gray); text-align: center; margin-bottom: 20px; }
        .card-timer { background: rgba(251, 191, 36, 0.1); color: var(--timer); padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid rgba(251, 191, 36, 0.2); font-size: 1.1em; }
        .timer-inizio { color: #60a5fa; background: rgba(96, 165, 250, 0.1); border-bottom: 1px solid rgba(96, 165, 250, 0.2); }
        .card { background: var(--card); border-radius: 18px; margin-bottom: 15px; border: 1px solid #334155; overflow: hidden; }
        .card.servizio { border-left: 6px solid var(--accent); }
        .card-header { padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .tag-serv { background: var(--accent); padding: 5px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 900; }
        .card-body { display: none; padding: 0; background: #0f172a; border-top: 1px solid #334155; }
        .card.open .card-body { display: block; }
        .viaggio-row { display: flex; padding: 15px; border-bottom: 1px solid #1e293b; }
        .viaggio-row.attivo { background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--green); padding-left: 11px; }
        .ora-box { min-width: 80px; color: var(--red); font-weight: 800; font-size: 1.1em; text-align: center; }
        .info-col { flex-grow: 1; padding-left: 15px; }
        .tm-label { background: #334155; color: white; padding: 3px 10px; border-radius: 6px; font-weight: bold; font-family: monospace; font-size: 1.2em; border: 1px solid var(--accent); }
        .giro-label { color: var(--timer); font-weight: bold; font-size: 0.95em; margin-top: 8px; display: inline-block; background: rgba(251, 191, 36, 0.1); padding: 5px 10px; border-radius: 5px; border: 1px dashed var(--timer); }
        .raggiungimento-label { color: #cbd5e1; font-weight: bold; font-size: 0.9em; margin-top: 8px; display: inline-block; background: #334155; padding: 4px 8px; border-radius: 5px; }
        .raggiungimento-alert { color: #fff; background: #ef4444; border: 2px solid #fff; animation: blinker 1.5s linear infinite; font-weight: 900; }
        .scarto-label { color: #fff; font-weight: bold; font-size: 0.9em; margin-top: 8px; display: inline-block; background: var(--purple); padding: 4px 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
        @keyframes blinker { 50% { opacity: 0.5; } }
        .tratta-text { font-size: 0.9em; color: #cbd5e1; margin-top: 8px; }
        .status-live { color: var(--green); font-size: 0.75em; font-weight: bold; display: block; margin-top: 5px; }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="unlock-screen" style="display:none;"><button class="btn-entra" onclick="sblocca()">üìÇ APRI TURNI</button></div>
    <div id="main-app" style="display:none;">
        <div class="update-info" id="sync-date"></div>
        <h2 style="text-align:center; color:var(--accent)">I Miei Turni</h2>
        <div id="lista-container"></div>
    </div>
</div>
<script>
    const PIN_HASH = "1509442"; 
    function hashMe(str) { let h = 0; for(let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0; return h.toString(); }
    function checkAccesso() {
        if (localStorage.getItem("aut_ok") === "true") { document.getElementById('unlock-screen').style.display = 'block'; }
        else { let p = prompt("Inserisci PIN:"); if (p && hashMe(p) === PIN_HASH) { localStorage.setItem("aut_ok", "true"); document.getElementById('unlock-screen').style.display = 'block'; } else { location.reload(); } }
    }
    function sblocca() { document.getElementById('unlock-screen').style.display = 'none'; document.getElementById('main-app').style.display = 'block'; caricaDati(); setInterval(caricaDati, 60000); }
    function calcolaCountdown(viaggi, dataStr) {
        if (!viaggi || viaggi.length === 0) return { testo: "", classe: "" };
        const ora = new Date();
        const gg = parseInt(dataStr.match(/\d+/));
        if (ora.getDate() !== gg) return { testo: "", classe: "" };
        const f = (s) => { let [h, m] = s.replace('.', ':').split(':'); let d = new Date(); d.setHours(h, m, 0); return d; };
        let dInizio = f(viaggi[0].inizio);
        let dFine = f(viaggi[viaggi.length - 1].fine);
        if (ora < dInizio) {
            let diffMs = dInizio - ora;
            let h = Math.floor(diffMs / 3600000);
            let m = Math.floor((diffMs % 3600000) / 60000);
            return { testo: `üöÄ Inizio turno tra: ${h}h ${m}m`, classe: "timer-inizio" };
        }
        if (ora <= dFine) {
            let diffMs = dFine - ora;
            let h = Math.floor(diffMs / 3600000);
            let m = Math.floor((diffMs % 3600000) / 60000);
            return { testo: `‚è≥ Fine turno tra: ${h}h ${m}m`, classe: "" };
        }
        return { testo: "üèÅ Servizio Terminato", classe: "" };
    }
    function caricaDati() {
        if (typeof datiTurni === 'undefined') return;
        document.getElementById('sync-date').innerText = "Dati aggiornati: " + (window.dataAggiornamento || "N.D.");
        const container = document.getElementById('lista-container');
        container.innerHTML = "";
        const oggi = new Date().getDate();
        datiTurni.forEach((t) => {
            const card = document.createElement('div');
            card.className = `card ${t.riposo ? 'riposo' : 'servizio'}`;
            if (t.data_estesa.includes(oggi.toString())) card.classList.add('open');
            let countdownHtml = "";
            if (!t.riposo && t.data_estesa.includes(oggi.toString())) {
                let res = calcolaCountdown(t.viaggi, t.data_estesa);
                if (res.testo) countdownHtml = `<div class="card-timer ${res.classe}">${res.testo}</div>`;
            }
            card.innerHTML = `<div class="card-header" onclick="this.parentElement.classList.toggle('open')"><span><b>${t.data_estesa}</b></span><span class="tag-serv">${t.servizio}</span></div>
                <div class="card-body">${countdownHtml}${t.riposo ? '<div style="padding:20px;text-align:center">üè† RIPOSO</div>' : generaViaggiHtml(t.viaggi, t.data_estesa)}</div>`;
            container.appendChild(card);
        });
    }
    function generaViaggiHtml(viaggi, dataS) {
        return viaggi.map(v => {
            const attivo = isLive(v.inizio, v.fine, dataS);
            let badgeHtml = "", tmHtml = "";
            if (v.scarto) {
                tmHtml = `<span class="tm-label" style="font-size: 0.8em; opacity: 0.8;">TM ${v.tm}</span> `;
                badgeHtml = `<span class="scarto-label">üîå SCARTA TRAM (CV)</span>`;
            } else if (v.raggiungimento) {
                let [hi, mi] = v.inizio.replace('.',':').split(':');
                let [hf, mf] = v.fine.replace('.',':').split(':');
                let minuti = (parseInt(hf)*60 + parseInt(mf)) - (parseInt(hi)*60 + parseInt(mi));
                let alertClass = (minuti > 25) ? "raggiungimento-alert" : "";
                badgeHtml = `<span class="raggiungimento-label ${alertClass}">üö∂ RAGGIUNGIMENTO: ${minuti} min</span>`;
                tmHtml = ""; 
            } else if (v.durata_giro) {
                tmHtml = `<span class="tm-label">TM ${v.tm}</span>`;
                badgeHtml = `<span class="giro-label">üîÑ GIRO: ${v.durata_giro}</span>`;
            }
            return `<div class="viaggio-row ${attivo ? 'attivo' : ''}"><div class="ora-box">${v.inizio}<br>${v.fine}</div>
                <div class="info-col">${tmHtml} ${attivo ? '<span class="status-live">‚óè IN CORSO</span>' : ''}<br>${badgeHtml}
                <div class="tratta-text"><b>DA:</b> ${v.da}<br><b>A:</b> ${v.a}${v.pausa ? `<br>‚òï Pausa: ${v.pausa}` : ''}</div></div></div>`;
        }).join('');
    }
    function isLive(i, f, d) {
        const n = new Date();
        const gg = parseInt(d.match(/\d+/));
        if (n.getDate() !== gg) return false;
        const p = (s) => { let [h, m] = s.replace('.',':').split(':'); let d = new Date(); d.setHours(h,m,0); return d; };
        return n >= p(i) && n <= p(f);
    }
    window.onload = checkAccesso;
</script>
</body>
</html>