<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tramvia Dashboard</title>
    <style>
        :root { --bg: #0b0f1a; --card: #161e2d; --accent: #38bdf8; --green: #22c55e; --orange: #f59e0b; --text: #f1f5f9; --dim: #94a3b8; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        /* Menu e Navigazione */
        #main-menu { display: none; text-align: center; padding-top: 40px; }
        .btn-big { background: var(--card); border: 2px solid #2d3a4f; color: var(--text); padding: 50px 20px; border-radius: 24px; font-size: 1.8rem; font-weight: bold; width: 100%; max-width: 350px; margin: 10px auto; display: block; }
        
        #turni-section { display: none; }
        .header-app { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-back { background: #2d3a4f; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; }

        .nav { display: flex; gap: 8px; margin-bottom: 15px; }
        .nav-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; background: var(--card); color: var(--dim); font-weight: bold; font-size: 0.9rem; }
        .nav-btn.active { background: var(--accent); color: #0b0f1a; }

        /* CARD TURNO AGGIORNATA */
        .card { background: var(--card); border-radius: 24px; margin-bottom: 15px; border: 1px solid #2d3a4f; overflow: hidden; }
        .card.today { border: 3px solid var(--accent); }
        
        .timer { background: rgba(56, 189, 248, 0.15); color: var(--accent); padding: 12px; text-align: center; font-weight: 800; font-size: 1rem; border-bottom: 1px solid #2d3a4f; letter-spacing: 1px; }
        
        .card-header { padding: 20px; cursor: pointer; }
        .top-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .date-box { font-size: 1.1rem; font-weight: bold; color: var(--dim); }
        
        /* ORARIO MONTATA/SMONTATA GIGANTE */
        .main-time { font-size: 2.2rem; font-weight: 900; color: var(--green); display: block; margin: 5px 0; letter-spacing: -1px; }
        
        .badges-row { display: flex; gap: 10px; margin-top: 8px; }
        .badge { padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 0.85rem; }
        .badge-guida { background: var(--accent); color: #000; }
        .badge-servizio { background: #2d3a4f; color: var(--text); }

        /* DETTAGLI VIAGGI (TM GRANDE) */
        .details { display: none; padding: 0 20px 20px 20px; border-top: 1px solid #2d3a4f; background: rgba(255,255,255,0.02); }
        .expanded .details { display: block; }
        
        .trip-row { padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .trip-row:last-child { border: none; }
        
        .tm-display { font-size: 1.8rem; font-weight: 900; color: var(--accent); display: block; margin-bottom: 4px; }
        .trip-times { font-size: 1.3rem; font-weight: bold; color: var(--green); margin-bottom: 5px; }
        .trip-loc { font-size: 0.95rem; color: var(--text); opacity: 0.9; }
        
        .forfait-alert { background: var(--orange); color: #000; font-weight: 900; padding: 10px; border-radius: 10px; width: 100%; box-sizing: border-box; text-align: center; margin-top: 10px; font-size: 0.9rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .pausa-tag { color: var(--green); font-weight: bold; font-size: 1rem; margin-top: 12px; background: rgba(34, 197, 94, 0.15); padding: 8px 15px; border-radius: 10px; display: inline-block; border: 1px solid var(--green); }
        .riposo { padding: 30px; text-align: center; color: var(--dim); border: 2px dashed #2d3a4f; border-radius: 20px; margin: 10px 0; font-size: 1.2rem; }
        
        #login-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box" style="background:var(--card); padding:40px; border-radius:30px; text-align:center;">
            <h2 style="color:var(--accent)">TRAMVIA HUB</h2>
            <input type="password" id="pin" inputmode="numeric" placeholder="PIN" style="width:80%; padding:15px; font-size:2rem; background:#000; border:1px solid var(--accent); color:white; border-radius:15px; text-align:center;">
            <button onclick="login()" style="width:85%; padding:15px; margin-top:20px; border-radius:15px; background:var(--accent); font-weight:bold; border:none; font-size:1.2rem;">ENTRA</button>
        </div>
    </div>

    <div id="main-menu">
        <h1 style="font-size: 2.2rem;">Ciao Nikita!</h1>
        <button class="btn-big" onclick="showSection('turni-section')">
            <div style="font-size: 3rem; margin-bottom: 10px;">üöã</div>
            SERVIZIO
        </button>
    </div>

    <div id="turni-section">
        <div class="header-app">
            <button class="btn-back" onclick="showSection('main-menu')">‚Üê MENU</button>
            <h2 style="color:var(--accent); margin:0;">TURNI</h2>
        </div>
        
        <div class="nav">
            <button id="f-btn" class="nav-btn active" onclick="setTab('f')">PROSSIMI</button>
            <button id="p-btn" class="nav-btn" onclick="setTab('p')">PASSATI</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        let turniData = [];
        let tabAttiva = 'f';
        let openId = null;

        function login() {
            if(document.getElementById('pin').value === '2007') {
                localStorage.setItem('tram_auth', '1');
                init();
            }
        }

        function init() {
            document.getElementById('login-screen').style.display = 'none';
            showSection('main-menu');
            load();
            setInterval(render, 1000);
        }

        function showSection(id) {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('turni-section').style.display = 'none';
            document.getElementById(id).style.display = 'block';
        }

        async function load() {
            const r = await fetch('turni.json?t=' + Date.now());
            turniData = await r.json();
            render();
        }

        function setTab(t) {
            tabAttiva = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t+'-btn').classList.add('active');
            render();
        }

        function toggle(id) {
            openId = (openId === id) ? null : id;
            render();
        }

        function getCD(inizio) {
            const ora = new Date();
            const [h, m] = inizio.split('.').map(Number);
            const target = new Date(); target.setHours(h, m, 0);
            const diff = target - ora;
            if (diff <= 0) return "üöã IN SERVIZIO";
            const hh = Math.floor(diff / 3600000);
            const mm = Math.floor((diff % 3600000) / 60000);
            const ss = Math.floor((diff % 60000) / 1000);
            return `INIZIO TRA: ${hh}h ${mm}m ${ss}s`;
        }

        function render() {
            const list = document.getElementById('list');
            if(!list) return;
            const oggiNum = new Date().getDate();
            let html = '';

            turniData.forEach((t, i) => {
                const giorno = parseInt(t.data_estesa.match(/\d+/));
                const isOggi = giorno === oggiNum;
                if ((tabAttiva === 'f' && giorno < oggiNum) || (tabAttiva === 'p' && giorno >= oggiNum)) return;
                
                if (t.riposo) {
                    html += `<div class="riposo"><b>${t.data_estesa}</b><br>RIPOSO üò¥</div>`;
                    return;
                }

                const expanded = isOggi || openId === i;
                const timer = isOggi ? `<div class="timer">${getCD(t.orario.split('-')[0].trim())}</div>` : '';

                html += `
                    <div class="card ${isOggi ? 'today' : ''} ${expanded ? 'expanded' : ''}">
                        ${timer}
                        <div class="card-header" onclick="toggle(${i})">
                            <div class="top-info">
                                <div class="date-box">${t.data}</div>
                                <div style="color:var(--dim)">${!isOggi ? 'VEDI DETTAGLI ‚ñº' : ''}</div>
                            </div>
                            <span class="main-time">${t.orario}</span>
                            <div class="badges-row">
                                <div class="badge badge-guida">GUIDA: ${t.servizio}</div>
                                <div class="badge badge-servizio">TURNO: ${t.servizio}</div>
                            </div>
                        </div>
                        <div class="details">
                            ${t.viaggi.map(v => `
                                <div class="trip-row">
                                    <span class="tm-display">TM ${v.tm}</span>
                                    <div class="trip-times">${v.inizio} ‚Äî ${v.fine}</div>
                                    <div class="trip-loc">${v.da} ‚ûî ${v.a}</div>
                                    ${v.forfait ? '<div class="forfait-alert">‚ö†Ô∏è RAGGIUNGIMENTO FORFETTARIO</div>' : ''}
                                    ${v.pausa ? `<div class="pausa-tag">PAUSA: ${v.pausa} min</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        if(localStorage.getItem('tram_auth')) init();
    </script>
</body>
</html>