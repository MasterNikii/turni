<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Area Turni Tramvia</title>
    <script src="turni.js"></script>
    <style>
        :root { --bg: #0b1120; --card: #1e293b; --accent: #3b82f6; --text: #f1f5f9; --timer: #fbbf24; --red: #f87171; --green: #22c55e; --gray: #64748b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .wrapper { width: 100%; max-width: 500px; }
        
        /* Schermata Sblocco */
        #unlock-screen { text-align: center; margin-top: 80px; }
        .btn-entra { background: var(--accent); color: white; border: none; padding: 20px 45px; border-radius: 15px; font-size: 1.4em; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }

        h2 { text-align: center; color: var(--accent); margin-bottom: 5px; }
        .update-info { font-size: 0.75em; color: var(--gray); text-align: center; margin-bottom: 20px; }
        
        /* Countdown Timer */
        .card-timer { background: rgba(251, 191, 36, 0.1); color: var(--timer); padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid rgba(251, 191, 36, 0.2); font-size: 1.1em; }
        
        /* Card Turno */
        .card { background: var(--card); border-radius: 18px; margin-bottom: 15px; border: 1px solid #334155; overflow: hidden; }
        .card.servizio { border-left: 6px solid var(--accent); }
        .card.riposo { border-left: 6px solid var(--gray); opacity: 0.6; }
        
        .card-header { padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .tag-serv { background: var(--accent); padding: 5px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 900; }
        
        .card-body { display: none; padding: 0; background: #0f172a; border-top: 1px solid #334155; }
        .card.open .card-body { display: block; }
        
        /* Singolo Viaggio */
        .viaggio-row { display: flex; padding: 15px; border-bottom: 1px solid #1e293b; }
        .viaggio-row:last-child { border-bottom: none; }
        .viaggio-row.attivo { background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--green); padding-left: 11px; }
        
        .ora-box { min-width: 80px; color: var(--red); font-weight: 800; font-size: 1.1em; text-align: center; }
        .info-col { flex-grow: 1; padding-left: 15px; }
        
        .tm-label { background: #334155; color: white; padding: 3px 10px; border-radius: 6px; font-weight: bold; font-family: monospace; font-size: 1.2em; border: 1px solid var(--accent); }
        .giro-label { color: var(--timer); font-weight: bold; font-size: 0.95em; margin-top: 8px; display: inline-block; background: rgba(251, 191, 36, 0.1); padding: 5px 10px; border-radius: 5px; border: 1px dashed var(--timer); }
        
        .tratta-text { font-size: 0.9em; color: #cbd5e1; margin-top: 8px; }
        .status-live { color: var(--green); font-size: 0.75em; font-weight: bold; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div id="unlock-screen" style="display:none;">
        <button class="btn-entra" onclick="sblocca()">üìÇ APRI TURNI</button>
    </div>

    <div id="main-app" style="display:none;">
        <div class="update-info" id="sync-date"></div>
        <h2>I Miei Turni</h2>
        <div id="lista-container"></div>
    </div>
</div>

<script>
    const PIN_HASH = "1509442"; // Corrisponde al PIN "1234"

    function hashMe(str) {
        let h = 0;
        for(let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;
        return h.toString();
    }

    function checkAccesso() {
        if (localStorage.getItem("aut_ok") === "true") {
            document.getElementById('unlock-screen').style.display = 'block';
        } else {
            let p = prompt("Inserisci PIN:");
            if (p && hashMe(p) === PIN_HASH) {
                localStorage.setItem("aut_ok", "true");
                document.getElementById('unlock-screen').style.display = 'block';
            } else {
                alert("PIN Errato!");
                location.reload();
            }
        }
    }

    function sblocca() {
        document.getElementById('unlock-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        caricaDati();
        
        // Auto-aggiorna il countdown ogni minuto
        setInterval(caricaDati, 60000); 
    }

    function calcolaCountdown(viaggi, dataStr) {
        if (!viaggi || viaggi.length === 0) return "";
        const ora = new Date();
        const gg = parseInt(dataStr.match(/\d+/));
        if (ora.getDate() !== gg) return "";

        const ultimoViaggio = viaggi[viaggi.length - 1];
        let [h, m] = ultimoViaggio.fine.replace('.', ':').split(':');
        let dFine = new Date();
        dFine.setHours(h, m, 0);

        if (ora > dFine) return "üèÅ Servizio Terminato";

        let diffMs = dFine - ora;
        let diffHrs = Math.floor(diffMs / 3600000);
        let diffMins = Math.floor((diffMs % 3600000) / 60000);

        return `‚è≥ Fine Turno in: ${diffHrs}h ${diffMins}m`;
    }

    function caricaDati() {
        if (typeof datiTurni === 'undefined') return;

        document.getElementById('sync-date').innerText = "Dati sincronizzati il: " + (typeof dataAggiornamento !== 'undefined' ? dataAggiornamento : "N.D.");

        const container = document.getElementById('lista-container');
        container.innerHTML = ""; // Svuota prima di ridisegnare
        const oggi = new Date().getDate();

        datiTurni.forEach((t) => {
            const card = document.createElement('div');
            card.className = `card ${t.riposo ? 'riposo' : 'servizio'}`;
            
            // Auto-apre la card di oggi
            if (t.data_estesa.includes(oggi.toString())) card.classList.add('open');

            let countdownHtml = "";
            if (!t.riposo && t.data_estesa.includes(oggi.toString())) {
                let textCountdown = calcolaCountdown(t.viaggi, t.data_estesa);
                if (textCountdown) {
                    countdownHtml = `<div class="card-timer">${textCountdown}</div>`;
                }
            }

            card.innerHTML = `
                <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
                    <span><b>${t.data_estesa}</b></span>
                    <span class="tag-serv">${t.servizio}</span>
                </div>
                <div class="card-body">
                    ${countdownHtml}
                    ${t.riposo ? '<div style="text-align:center; padding: 20px;">üè† MERITATO RIPOSO</div>' : generaViaggiHtml(t.viaggi, t.data_estesa)}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function generaViaggiHtml(viaggi, dataS) {
        return viaggi.map(v => {
            const attivo = isLive(v.inizio, v.fine, dataS);
            return `
                <div class="viaggio-row ${attivo ? 'attivo' : ''}">
                    <div class="ora-box">${v.inizio}<br>${v.fine}</div>
                    <div class="info-col">
                        <span class="tm-label">TM ${v.tm}</span>
                        ${attivo ? ' <span class="status-live">‚óè IN CORSO</span>' : ''}
                        
                        ${v.durata_giro ? `<br><span class="giro-label">üîÑ GIRO: ${v.durata_giro}</span>` : ''}
                        
                        <div class="tratta-text">
                            <b>DA:</b> ${v.da}<br>
                            <b>A:</b> ${v.a}
                            ${v.pausa ? `<br>‚òï Pausa: ${v.pausa}` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function isLive(inizio, fine, dataStr) {
        const ora = new Date();
        const gg = parseInt(dataStr.match(/\d+/));
        if (ora.getDate() !== gg) return false;

        const f = (s) => {
            let [h, m] = s.replace('.', ':').split(':');
            let d = new Date(); d.setHours(h, m, 0); return d;
        };
        return ora >= f(inizio) && ora <= f(fine);
    }

    window.onload = checkAccesso;
</script>
</body>
</html>