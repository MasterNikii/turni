<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turni Nikita - Tramvia</title>
    <script src="turni.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b1120; margin: 0; padding: 15px; color: white; }
        .container { max-width: 500px; margin: auto; }
        
        /* BOX COUNTDOWN */
        .countdown-box {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155; border-radius: 20px; padding: 20px;
            text-align: center; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-left: 5px solid #fbbf24;
        }
        .countdown-label { font-size: 0.85em; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        #timer { font-size: 1.8em; font-weight: bold; color: #fbbf24; display: block; margin-top: 10px; }

        /* CARD TURNI */
        .card { 
            background: #1e293b; border-radius: 15px; margin-bottom: 12px;
            border: 1px solid #334155; overflow: hidden; transition: 0.3s;
        }
        .card.servizio { border-left: 6px solid #3b82f6; }
        .card.riposo { border-left: 6px solid #64748b; opacity: 0.7; }
        
        .header { padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .header:hover { background: #334155; }
        .data-testo { font-weight: 600; color: #f1f5f9; font-size: 1.1em; }
        .servizio-tag { background: #3b82f6; color: white; padding: 5px 12px; border-radius: 8px; font-size: 0.9em; font-weight: bold; }

        .content { display: none; padding: 15px; background: #0f172a; border-top: 1px solid #334155; }
        .card.open .content { display: block; }

        .viaggio { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1e293b; }
        .orari { color: #f87171; font-weight: bold; font-size: 1.1em; min-width: 75px; }
        .stazioni { flex-grow: 1; padding: 0 15px; font-size: 0.95em; color: #cbd5e1; border-left: 1px solid #334155; margin-left: 10px; }
        
        .pausa-box { background: rgba(34, 197, 94, 0.1); color: #4ade80; padding: 10px; border-radius: 10px; margin-top: 12px; text-align: center; border: 1px solid rgba(34, 197, 94, 0.2); }
        .tm-info { font-size: 0.8em; color: #94a3b8; background: #334155; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="countdown-box">
        <span class="countdown-label">Prossimo turno inizia tra</span>
        <span id="timer">...caricamento...</span>
    </div>
    <div id="lista"></div>
</div>

<script>
    function calcolaCountdown() {
        if (typeof datiTurni === 'undefined' || datiTurni.length === 0) return;
        
        const oraAdesso = new Date();
        let prossimaData = null;

        for (let t of datiTurni) {
            // Saltiamo riposi o turni vuoti
            if (t.riposo || !t.viaggi || t.viaggi.length === 0) continue;
            
            // 1. Estraiamo il numero del giorno con una Regex (cerca cifre)
            const matchGiorno = t.data_estesa.match(/\d+/);
            if (!matchGiorno) continue;
            const giornoTurno = parseInt(matchGiorno[0]);
            
            // 2. Prendiamo l'orario del PRIMO viaggio disponibile
            // Puliamo la stringa: togliamo lettere, usiamo solo numeri e separatore
            let oraStr = t.viaggi[0].inizio.replace('.', ':').trim();
            const h = parseInt(oraStr.split(':')[0]);
            const m = parseInt(oraStr.split(':')[1]);

            if (isNaN(h) || isNaN(m)) continue;

            // 3. Costruiamo la data del turno
            let dataTurno = new Date(oraAdesso.getFullYear(), oraAdesso.getMonth(), giornoTurno, h, m);

            // Se il giorno √® piccolo (es. 1) e oggi √® fine mese (es. 30), √® il mese prossimo
            if (giornoTurno < oraAdesso.getDate() && oraAdesso.getDate() > 20) {
                dataTurno.setMonth(dataTurno.getMonth() + 1);
            }

            // Se questa data √® dopo "adesso", abbiamo trovato il prossimo turno!
            if (dataTurno > oraAdesso) {
                prossimaData = dataTurno;
                break;
            }
        }

        const timerEl = document.getElementById('timer');
        if (!prossimaData) {
            timerEl.innerHTML = "NESSUN TURNO DISPONIBILE";
            return;
        }

        function update() {
            const ora = new Date().getTime();
            const distanza = prossimaData.getTime() - ora;
            
            if (distanza <= 0) { 
                timerEl.innerHTML = "IN SERVIZIO!"; 
                return; 
            }

            const h = Math.floor(distanza / (1000 * 60 * 60));
            const m = Math.floor((distanza % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distanza % (1000 * 60)) / 1000);
            
            timerEl.innerHTML = h + "h " + m + "m " + s + "s";
        }
        setInterval(update, 1000);
        update();
    }

    function generaLista() {
        const contenitore = document.getElementById('lista');
        if (typeof datiTurni === 'undefined') return;

        datiTurni.forEach((t, index) => {
            const card = document.createElement('div');
            card.className = 'card ' + (t.riposo ? 'riposo' : 'servizio');
            // Apre solo il primo turno della lista
            if (index === 0) card.classList.add('open');

            let html = `
                <div class="header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="data-testo">${t.data_estesa}</span>
                    <span class="servizio-tag">${t.servizio}</span>
                </div>
                <div class="content">
            `;

            if (t.riposo) {
                html += `<div style="text-align:center; padding:10px; color:#94a3b8;">üè† Riposo Settimanale</div>`;
            } else {
                t.viaggi.forEach(v => {
                    if (v.inizio.includes('Inizio') || v.inizio === '') return;
                    html += `
                        <div class="viaggio">
                            <div class="orari">${v.inizio}<br>${v.fine}</div>
                            <div class="stazioni">
                                <b>DA:</b> ${v.da}<br>
                                <b>A:</b> ${v.a}
                            </div>
                            <div class="tm-info">TM ${v.tm}</div>
                        </div>
                        ${v.pausa && v.pausa !== 'Brk min' ? `<div class="pausa-box">‚òï Pausa di ${v.pausa} min</div>` : ''}
                    `;
                });
            }
            html += `</div>`;
            card.innerHTML = html;
            contenitore.appendChild(card);
        });
    }

    generaLista();
    calcolaCountdown();
</script>
</body>
</html>

</body>
</html>