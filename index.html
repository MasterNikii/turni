<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tramvia App</title>
    <style>
        :root { --bg: #0b0f1a; --card: #161e2d; --accent: #38bdf8; --green: #22c55e; --text: #f1f5f9; --dim: #94a3b8; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; }
        
        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #2d3a4f; text-align: center; width: 85%; max-width: 300px; }
        input { width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px; border: 1px solid #2d3a4f; background: #0b0f1a; color: white; text-align: center; font-size: 1.5rem; box-sizing: border-box; }
        
        /* Layout */
        .nav { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; background: var(--card); color: var(--dim); font-weight: bold; font-size: 0.8rem; }
        .nav-btn.active { background: var(--accent); color: #0b0f1a; }

        .card { background: var(--card); border-radius: 18px; margin-bottom: 15px; border: 1px solid #2d3a4f; overflow: hidden; }
        .card.today { border: 2px solid var(--accent); box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
        
        .countdown { background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; border-bottom: 1px solid #2d3a4f; }
        
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .tm-badge { background: #2d3a4f; color: var(--accent); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-top: 4px; }
        .time-main { color: var(--green); font-weight: bold; font-size: 1.3rem; }

        .details { padding: 15px; border-top: 1px solid #2d3a4f; background: rgba(0,0,0,0.1); }
        .trip { padding: 10px 0; border-bottom: 1px solid #2d3a4f; }
        .trip:last-child { border: none; }
        .trip-top { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; }
        .pausa-box { color: var(--green); font-weight: bold; font-size: 0.85rem; margin-top: 6px; border-left: 3px solid var(--green); padding-left: 8px; }
        
        .riposo { padding: 20px; text-align: center; color: var(--dim); border: 1px dashed #2d3a4f; border-radius: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>PIN ACCESSO</h2>
            <input type="password" id="pin" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢">
            <button onclick="login()" style="width:100%; padding:15px; border-radius:12px; background:var(--accent); border:none; font-weight:bold;">ENTRA</button>
        </div>
    </div>

    <div id="main" style="display:none">
        <div class="nav">
            <button id="f-btn" class="nav-btn active" onclick="setTab('f')">PROGRAMMA</button>
            <button id="p-btn" class="nav-btn" onclick="setTab('p')">ARCHIVIO</button>
        </div>
        <div id="list"></div>
    </div>

    <script>
        let data = [];
        let tab = 'f';

        function login() {
            if(document.getElementById('pin').value === '2007') {
                localStorage.setItem('auth', '1');
                init();
            }
        }

        function init() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            load();
            setInterval(render, 1000);
        }

        async function load() {
            const r = await fetch('turni.json?t=' + Date.now());
            data = await r.json();
            render();
        }

        function setTab(t) {
            tab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t+'-btn').classList.add('active');
            render();
        }

        function getTimer(inizio) {
            const ora = new Date();
            const [h, m] = inizio.split('.').map(Number);
            const target = new Date(); target.setHours(h, m, 0);
            const diff = target - ora;
            if (diff <= 0) return "IN SERVIZIO ðŸš‹";
            const hh = Math.floor(diff / 3600000);
            const mm = Math.floor((diff % 3600000) / 60000);
            const ss = Math.floor((diff % 60000) / 1000);
            return `INIZIO TRA: ${hh}h ${mm}m ${ss}s`;
        }

        function render() {
            const list = document.getElementById('list');
            list.innerHTML = '';
            const oggi = new Date().getDate();

            data.forEach(t => {
                const gT = parseInt(t.data_estesa.match(/\d+/));
                const isOggi = gT === oggi;
                if ((tab === 'f' && gT < oggi) || (tab === 'p' && gT >= oggi)) return;

                if (t.riposo) {
                    list.innerHTML += `<div class="riposo"><b>${t.data_estesa}</b><br>RIPOSO</div>`;
                    return;
                }

                const card = document.createElement('div');
                card.className = `card ${isOggi ? 'today' : ''}`;
                let timer = isOggi ? `<div class="countdown">${getTimer(t.orario.split('-')[0].trim())}</div>` : '';

                card.innerHTML = `
                    ${timer}
                    <div class="card-header">
                        <div>
                            <div style="font-weight:bold">${t.data}</div>
                            <div class="tm-badge">TURNO ${t.servizio}</div>
                        </div>
                        <div class="time-main">${t.orario}</div>
                    </div>
                    <div class="details">
                        ${t.viaggi.map(v => `
                            <div class="trip">
                                <div class="trip-top">
                                    <span style="color:var(--accent)">TM ${v.tm || '--'}</span>
                                    <span>${v.inizio} - ${v.fine}</span>
                                </div>
                                <div style="font-size:0.85rem; color:var(--dim)">${v.da} âž” ${v.a}</div>
                                ${v.pausa && v.pausa !== '0' ? `<div class="pausa-box">PAUSA: ${v.pausa}'</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        if(localStorage.getItem('auth') === '1') init();
    </script>
</body>
</html>